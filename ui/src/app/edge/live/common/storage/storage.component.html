<oe-flat-widget [class]="storageIconStyle" [icon]="{name: 'oe-storage', color: 'success'}"
    [title]="'General.storageSystem'| translate" (click)="presentModal()" *ngIf="isInitialized">
    <ng-container *ngFor="let component of essComponents, let i = index">

        <!-- Show Alias if there are more than one ESS -->
        <ng-container *ngIf="essComponents.length > 1">
            <oe-flat-widget-line [name]="component.alias">
            </oe-flat-widget-line>
        </ng-container>

        <!-- Check if either EmergencyReserve or ChargeDischargeLimiter is active -->
        <ng-container
            *ngIf="(emergencyReserveComponents[component.id] || chargeDischargeLimiterComponents[component.id]) as reserveOrLimiter, else noReserveOrLimiter">
            <oe-flat-widget-percentagebar [channelAddress]="component.id + '/Soc'">

                <!-- Combined SVG for both markers -->
                <svg>
                    <!-- Marker for Emergency Reserve (if enabled) -->
                    <ng-container *ngIf="this.emergencyReserveComponents[component.id] as reserve">
                        <rect y="3" rx="0" ry="0" width="1%"
                            [attr.x]="'calc(' + (reserve['currentReserveSoc'] > 98 ? 98 : reserve['currentReserveSoc']) + '% + 2px)'"
                            height="18" style="fill:#0008;" />
                    </ng-container>

                    <!-- Markers for ChargeDischargeLimiter (if enabled) -->
                    <ng-container *ngIf="this.chargeDischargeLimiterComponents[component.id] as limiter">
                        <!-- Marker for Min SOC -->
                        <rect y="3" rx="0" ry="0" width="1%"
                            [attr.x]="'calc(' + (limiter['minSoc'] > 98 ? 98 : limiter['minSoc']) + '% + 2px)'"
                            height="18" style="fill:#3c383888;" />
                        <!-- Condition based on state < 4 -->
                        <ng-container *ngIf="limiter['state'] < 4; else forceBlock">
                            <!-- Marker for Max SOC -->
                            <rect y="3" rx="0" ry="0" width="1%"
                                [attr.x]="'calc(' + (limiter['maxSoc'] > 98 ? 98 : limiter['maxSoc']) + '% + 2px)'"
                                height="18" style="fill:#3c383888;" />
                        </ng-container>
                        <ng-template #forceBlock>
                            <!-- Marker for Max SOC -->
                            <rect y="3" rx="0" ry="0" width="1%"
                                [attr.x]="'calc(' + (limiter['forceSoc'] > 98 ? 98 : limiter['forceSoc']) + '% + 2px)'"
                                height="18" style="fill:#88000088;" />
                        </ng-template>
                    </ng-container>
                </svg>

            </oe-flat-widget-percentagebar>
        </ng-container>

        <ng-template #noReserveOrLimiter>
            <oe-flat-widget-percentagebar [channelAddress]="component.id + '/Soc'">
            </oe-flat-widget-percentagebar>
        </ng-template>

        <ng-container *ngIf="!isHybridEss[component.id], else HybridEss">
            <!-- For AC system: show ActivePower channel -->
            <oe-flat-widget-line [name]="'General.chargePower' | translate"
                [channelAddress]="component.id + '/ActivePower'" [converter]="convertChargePower">
            </oe-flat-widget-line>
            <oe-flat-widget-line [name]="'General.dischargePower' | translate"
                [channelAddress]="component.id + '/ActivePower'" [converter]="convertDischargePower">
            </oe-flat-widget-line>
        </ng-container>

        <ng-template #HybridEss>
            <!-- For DC/hybrid system: show DcDischargePower channel -->
            <oe-flat-widget-line [name]="'General.chargePower' | translate"
                [channelAddress]="component.id + '/DcDischargePower'" [converter]="convertChargePower">
            </oe-flat-widget-line>
            <oe-flat-widget-line [name]="'General.dischargePower' | translate"
                [channelAddress]="component.id + '/DcDischargePower'" [converter]="convertDischargePower">
            </oe-flat-widget-line>
        </ng-template>

        <ng-container *ngIf="possibleBatteryExtensionMessage.get(component.id) as message">
            <oe-flat-widget-horizontal-line></oe-flat-widget-horizontal-line>
            <oe-flat-widget-line [name]="message.text" leftColumnWidth="100"
                [style.color]="message.color"></oe-flat-widget-line>
        </ng-container>


        <oe-flat-widget-horizontal-line [components]="essComponents" [index]="i">
        </oe-flat-widget-horizontal-line>

    </ng-container>
</oe-flat-widget>
